name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Build binaries
      run: |
        # Build for amd64
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" -o wsconsole-linux-amd64 ./cmd/wsconsole
        
        # Build for arm64
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" -o wsconsole-linux-arm64 ./cmd/wsconsole
        
        # Build for armv7
        CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" -o wsconsole-linux-armv7 ./cmd/wsconsole

    - name: Create zip archives
      run: |
        # Create zip for amd64
        mkdir -p wsconsole-linux-amd64-package
        cp wsconsole-linux-amd64 wsconsole-linux-amd64-package/wsconsole
        cp -r deploy/static wsconsole-linux-amd64-package/
        cp -r deploy/systemd wsconsole-linux-amd64-package/
        cp -r deploy/polkit wsconsole-linux-amd64-package/
        cp README.md LICENSE wsconsole-linux-amd64-package/
        cd wsconsole-linux-amd64-package
        zip -r ../wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-amd64.zip .
        cd ..
        
        # Create zip for arm64
        mkdir -p wsconsole-linux-arm64-package
        cp wsconsole-linux-arm64 wsconsole-linux-arm64-package/wsconsole
        cp -r deploy/static wsconsole-linux-arm64-package/
        cp -r deploy/systemd wsconsole-linux-arm64-package/
        cp -r deploy/polkit wsconsole-linux-arm64-package/
        cp README.md LICENSE wsconsole-linux-arm64-package/
        cd wsconsole-linux-arm64-package
        zip -r ../wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip .
        cd ..
        
        # Create zip for armv7
        mkdir -p wsconsole-linux-armv7-package
        cp wsconsole-linux-armv7 wsconsole-linux-armv7-package/wsconsole
        cp -r deploy/static wsconsole-linux-armv7-package/
        cp -r deploy/systemd wsconsole-linux-armv7-package/
        cp -r deploy/polkit wsconsole-linux-armv7-package/
        cp README.md LICENSE wsconsole-linux-armv7-package/
        cd wsconsole-linux-armv7-package
        zip -r ../wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-armv7.zip .
        cd ..

    - name: Build deb package (amd64)
      run: |
        # Build binary for deb
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o wsconsole ./cmd/wsconsole
        
        # Create deb package structure
        make deb VERSION=${{ steps.get_version.outputs.VERSION }} DEB_ARCH=amd64

    - name: Build deb package (arm64)
      run: |
        # Build binary for deb
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o wsconsole ./cmd/wsconsole

        # Create deb package structure
        make deb VERSION=${{ steps.get_version.outputs.VERSION }} DEB_ARCH=arm64

    - name: Generate checksums
      run: |
        sha256sum wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-amd64.zip > checksums.txt
        sha256sum wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip >> checksums.txt
        sha256sum wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-armv7.zip >> checksums.txt

    - name: Create Release Notes
      run: |
        cat > release_notes.md << 'EOF'
        ## wsconsole ${{ steps.get_version.outputs.VERSION }}
        
        ### Download
        
        #### Debian/Ubuntu Packages
        - **amd64**: `wsconsole_${{ steps.get_version.outputs.VERSION }}_amd64.deb`
        - **arm64**: `wsconsole_${{ steps.get_version.outputs.VERSION }}_arm64.deb`
        
        Install with:
        ```bash
        sudo dpkg -i wsconsole_${{ steps.get_version.outputs.VERSION }}_amd64.deb
        sudo systemctl start wsconsole
        ```
        
        #### Binary Archives (zip)
        - **Linux amd64**: `wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-amd64.zip`
        - **Linux arm64**: `wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip`
        - **Linux armv7**: `wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-armv7.zip`
        
        Extract and run:
        ```bash
        unzip wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-amd64.zip
        ./wsconsole --addr=:8080
        ```
        
        ### Checksums
        See `checksums.txt` for SHA256 checksums.
        
        ### What's Changed
        - See commit history for details
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-amd64.zip
          wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip
          wsconsole-${{ steps.get_version.outputs.VERSION }}-linux-armv7.zip
          wsconsole_${{ steps.get_version.outputs.VERSION }}_amd64.deb
          wsconsole_${{ steps.get_version.outputs.VERSION }}_arm64.deb
          checksums.txt
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
